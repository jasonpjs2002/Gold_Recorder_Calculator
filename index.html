<!doctype html>
<html lang="en">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Gold Business Calculator</title>
  <script src="/_sdk/element_sdk.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    * {
      box-sizing: border-box;
    }
    
    body {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100%;
      height: 100%;
    }
    
    html {
      height: 100%;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }
    
    .header {
      background: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    
    .header h1 {
      margin: 0 0 10px 0;
      color: #667eea;
      font-size: 32px;
      font-weight: 700;
    }
    
    .header p {
      margin: 0;
      color: #666;
      font-size: 16px;
    }
    
    .input-card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 25px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    
    .input-card h2 {
      margin: 0 0 25px 0;
      color: #333;
      font-size: 22px;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
    }
    
    .form-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 20px;
    }
    
    .form-group {
      display: flex;
      flex-direction: column;
    }
    
    .form-group label {
      margin-bottom: 8px;
      color: #333;
      font-weight: 600;
      font-size: 14px;
    }
    
    .form-group input,
    .form-group textarea {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.3s;
      font-family: inherit;
    }
    
    .form-group input:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    .form-group textarea {
      resize: vertical;
      min-height: 80px;
    }
    
    .button-group {
      display: flex;
      gap: 15px;
      margin-top: 25px;
      flex-wrap: wrap;
    }
    
    .btn {
      padding: 14px 28px;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    
    .btn-primary {
      background: #667eea;
      color: white;
    }
    
    .btn-primary:hover {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(102, 126, 234, 0.4);
    }
    
    .btn-secondary {
      background: #48bb78;
      color: white;
    }
    
    .btn-secondary:hover {
      background: #38a169;
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(72, 187, 120, 0.4);
    }
    
    .btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .records-card {
      background: white;
      border-radius: 15px;
      padding: 30px;
      box-shadow: 0 8px 16px rgba(0,0,0,0.15);
    }
    
    .records-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .records-header h2 {
      margin: 0;
      color: #333;
      font-size: 22px;
    }
    
    .filter-wrapper {
      display: flex;
      gap: 12px;
      align-items: center;
    }
    
    .filter-wrapper label {
      font-size: 14px;
      font-weight: 600;
      color: #333;
    }
    
    .filter-wrapper select {
      padding: 10px 16px;
      border: 2px solid #667eea;
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
      background: white;
      font-weight: 600;
      color: #333;
    }
    
    .table-wrapper {
      overflow-x: auto;
    }
    
    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 14px;
    }
    
    th {
      background: #667eea;
      color: white;
      padding: 14px;
      text-align: left;
      font-weight: 600;
      white-space: nowrap;
    }
    
    td {
      padding: 14px;
      border-bottom: 1px solid #e0e0e0;
    }
    
    tbody tr:hover {
      background: #f8f9fa;
    }
    
    .number-cell {
      text-align: right;
      font-weight: 600;
    }
    
    .positive {
      color: #48bb78;
    }
    
    .negative {
      color: #f56565;
    }
    
    .action-btn {
      padding: 8px 14px;
      background: #f56565;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 13px;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .action-btn:hover {
      background: #e53e3e;
      transform: scale(1.05);
    }
    
    .action-btn:disabled {
      background: #ccc;
      cursor: not-allowed;
      transform: none;
    }
    
    .summary-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
      gap: 20px;
      margin-bottom: 25px;
    }
    
    .summary-box {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .summary-label {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 10px;
    }
    
    .summary-value {
      font-size: 28px;
      font-weight: 700;
    }
    
    .settlement-card {
      background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
      color: white;
      padding: 28px;
      border-radius: 12px;
      margin-top: 25px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.15);
    }
    
    .settlement-card h3 {
      margin: 0 0 10px 0;
      font-size: 22px;
      border-bottom: 2px solid rgba(255,255,255,0.3);
      padding-bottom: 14px;
    }
    
    .date-range {
      font-size: 13px;
      opacity: 0.85;
      margin-bottom: 20px;
    }
    
    .settlement-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
    }
    
    .settlement-item {
      font-size: 14px;
      opacity: 0.9;
      margin-bottom: 6px;
    }
    
    .settlement-value {
      font-size: 30px;
      font-weight: 700;
    }
    
    .settlement-desc {
      font-size: 12px;
      opacity: 0.8;
      margin-top: 6px;
    }
    
    .settlement-status {
      font-size: 20px;
      font-weight: 700;
      margin-top: 10px;
    }
    
    .empty-state {
      text-align: center;
      padding: 50px;
      color: #999;
    }
    
    .empty-state svg {
      width: 70px;
      height: 70px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
    
    .toast {
      position: fixed;
      bottom: 25px;
      right: 25px;
      background: #333;
      color: white;
      padding: 18px 26px;
      border-radius: 10px;
      box-shadow: 0 6px 16px rgba(0,0,0,0.3);
      z-index: 1000;
      animation: slideIn 0.3s ease-out;
      font-weight: 600;
    }
    
    @keyframes slideIn {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }
    
    @media (max-width: 768px) {
      .form-grid {
        grid-template-columns: 1fr;
      }
      
      .button-group {
        flex-direction: column;
      }
      
      .btn {
        width: 100%;
        justify-content: center;
      }
    }
  </style>
  <style>@view-transition { navigation: auto; }</style>
  <script src="/_sdk/data_sdk.js" type="text/javascript"></script>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body>
  <div class="container">
   <div class="header">
    <h1 id="app-title">Gold Business Calculator</h1>
    <p>Track your daily gold transactions with the factory</p>
   </div>
   <div class="input-card">
    <h2>üìù Add New Record</h2>
    <form id="record-form">
     <div class="form-grid">
      <div class="form-group"><label for="date">Date / Êó•Êúü *</label> <input type="date" id="date" required>
      </div>
      <div class="form-group"><label for="gold-given">Gold Given (g) / ‰∫§Âá∫ÈáëÂÖãÊï∞</label> <input type="number" id="gold-given" step="0.01" min="0" placeholder="50.00">
      </div>
      <div class="form-group"><label for="gold-received">Gold Received (g) / Êî∂ÂõûÈáëÂÖãÊï∞</label> <input type="number" id="gold-received" step="0.01" min="0" placeholder="42.00">
      </div>
      <div class="form-group"><label for="balance">Balance (g) / ‰ΩôÈ¢ùÈáëÂÖãÊï∞ (Auto)</label> <input type="number" id="balance" step="0.01" placeholder="8.00" readonly style="background: #f5f5f5;">
      </div>
      <div class="form-group"><label for="labor-cost"><span id="currency-symbol">RM</span> Labor Cost / ÊâãÔøΩÔøΩÔøΩÔøΩ</label> <input type="number" id="labor-cost" step="0.01" min="0" placeholder="0.00">
      </div>
      <div class="form-group"><label for="payment-made"><span id="currency-symbol2">RM</span> Payment Made / Â∑≤‰ªòÊ¨æ</label> <input type="number" id="payment-made" step="0.01" min="0" placeholder="0.00">
      </div>
     </div>
     <div class="form-group"><label for="notes">Notes / Â§áÊ≥® (Optional)</label> <textarea id="notes" placeholder="Enter any additional notes..."></textarea>
     </div>
     <div class="button-group"><button type="submit" class="btn btn-primary"> <span>‚ûï Add Record</span> </button> <button type="button" class="btn btn-secondary" id="export-btn"> <span>üìÑ Export PDF (All)</span> </button> <button type="button" class="btn btn-secondary" id="export-excel-btn"> <span>üìä Export Excel (All)</span> </button>
     </div>
    </form>
   </div>
   <div class="records-card">
    <div class="records-header">
     <h2>üìä Summary</h2>
     <div class="filter-wrapper"><label for="month-filter">Filter by Month / ÈÄâÊã©Êúà‰ªΩ:</label> <select id="month-filter"> <option value="all">All Time / ÂÖ®ÈÉ®</option> </select>
     </div>
    </div>
    <div class="summary-grid">
     <div class="summary-box">
      <div class="summary-label">
       Total Gold Given
      </div>
      <div class="summary-value" id="total-given">
       0.00g
      </div>
     </div>
     <div class="summary-box">
      <div class="summary-label">
       Total Gold Received
      </div>
      <div class="summary-value" id="total-received">
       0.00g
      </div>
     </div>
     <div class="summary-box">
      <div class="summary-label">
       Total Balance
      </div>
      <div class="summary-value" id="total-balance">
       0.00g
      </div>
     </div>
     <div class="summary-box">
      <div class="summary-label">
       Total Labor Cost
      </div>
      <div class="summary-value" id="total-labor">
       RM 0.00
      </div>
     </div>
     <div class="summary-box">
      <div class="summary-label">
       Total Payments
      </div>
      <div class="summary-value" id="total-payments">
       RM 0.00
      </div>
     </div>
    </div>
    <div class="settlement-card">
     <h3>üí∞ Final Settlement / ÊúÄÔøΩÔøΩÔøΩÁªìÁÆó <span id="settlement-period"></span></h3>
     <div class="date-range" id="date-range"></div>
     <div class="settlement-grid">
      <div>
       <div class="settlement-item">
        Gold Balance / ÈªÑÈáë‰ΩôÈ¢ù
       </div>
       <div class="settlement-value" id="settlement-balance">
        0.00g
       </div>
       <div class="settlement-desc" id="balance-description">
        Factory owes you / Â∑•ÂéÇÊ¨†‰Ω†
       </div>
      </div>
      <div>
       <div class="settlement-item">
        Payment Status / ‰ªòÊ¨æÁä∂ÊÄÅ
       </div>
       <div class="settlement-value" id="settlement-unpaid">
        RM 0.00
       </div>
       <div class="settlement-desc" id="payment-description">
        You owe factory / ‰Ω†Ê¨†Â∑•ÂéÇ
       </div>
      </div>
      <div>
       <div class="settlement-item">
        Settlement Status / ÁªìÁÆóÁä∂ÊÄÅ
       </div>
       <div class="settlement-status" id="settlement-status">
        ‚úì All Settled
       </div>
      </div>
     </div>
    </div>
    <div class="records-header" style="margin-top: 30px;">
     <h2>üìã All Records</h2>
     <div style="display: flex; gap: 10px; flex-wrap: wrap;"><button type="button" class="btn btn-secondary" id="export-filtered-btn" style="padding: 10px 20px; font-size: 14px;"> <span>üìÑ Export PDF (Filtered)</span> </button> <button type="button" class="btn btn-secondary" id="export-excel-filtered-btn" style="padding: 10px 20px; font-size: 14px;"> <span>üìä Export Excel (Filtered)</span> </button>
     </div>
    </div>
    <div class="table-wrapper">
     <table>
      <thead>
       <tr>
        <th>Date</th>
        <th>Gold Given (g)</th>
        <th>Gold Received (g)</th>
        <th>Balance (g)</th>
        <th>Labor Cost</th>
        <th>Payment Made</th>
        <th>Notes</th>
        <th>Action</th>
       </tr>
      </thead>
      <tbody id="records-body">
       <tr>
        <td colspan="8" class="empty-state">
         <svg fill="none" stroke="currentColor" viewbox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
         </svg>
         <div>
          No records yet. Add your first transaction above!
         </div></td>
       </tr>
      </tbody>
     </table>
    </div>
   </div>
  </div>
  <script>
    // Configuration
    const defaultConfig = {
      app_title: "Gold Business Calculator",
      currency_label: "RM",
      background_color: "#667eea",
      surface_color: "#ffffff",
      text_color: "#333333",
      primary_action: "#667eea",
      secondary_action: "#48bb78"
    };
    
    // State
    let allRecords = [];
    let selectedMonth = 'all';
    const STORAGE_KEY = 'goldBusinessRecords';
    
    // LocalStorage Functions
    function loadRecords() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (stored) {
          allRecords = JSON.parse(stored);
        }
      } catch (error) {
        console.error('Error loading records:', error);
        showToast('‚ö†Ô∏è Error loading saved records');
      }
    }
    
    function saveRecords() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(allRecords));
      } catch (error) {
        console.error('Error saving records:', error);
        showToast('‚ö†Ô∏è Error saving records');
      }
    }
    
    // Month Filter
    function populateMonthFilter() {
      const monthSet = new Set();
      allRecords.forEach(record => {
        const date = new Date(record.date);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        monthSet.add(monthKey);
      });
      
      const monthFilter = document.getElementById('month-filter');
      const currentValue = monthFilter.value;
      
      monthFilter.innerHTML = '<option value="all">All Time / ÂÖ®ÈÉ®</option>';
      
      Array.from(monthSet).sort().reverse().forEach(monthKey => {
        const [year, month] = monthKey.split('-');
        const date = new Date(year, month - 1);
        const monthName = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
        const option = document.createElement('option');
        option.value = monthKey;
        option.textContent = monthName;
        monthFilter.appendChild(option);
      });
      
      if (Array.from(monthSet).includes(currentValue)) {
        monthFilter.value = currentValue;
      } else {
        monthFilter.value = 'all';
        selectedMonth = 'all';
      }
    }
    
    function getFilteredRecords() {
      if (selectedMonth === 'all') {
        return allRecords;
      }
      
      return allRecords.filter(record => {
        const date = new Date(record.date);
        const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
        return monthKey === selectedMonth;
      });
    }
    
    // Table Update
    function updateRecordsTable() {
      const tbody = document.getElementById('records-body');
      const currencySymbol = window.elementSdk?.config?.currency_label || defaultConfig.currency_label;
      const filteredRecords = getFilteredRecords();
      
      if (allRecords.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              <div>No records yet. Add your first transaction above!</div>
            </td>
          </tr>
        `;
        return;
      }
      
      if (filteredRecords.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="8" class="empty-state">
              <div>No records for this month.</div>
            </td>
          </tr>
        `;
        return;
      }
      
      tbody.innerHTML = filteredRecords.map(record => {
        const date = new Date(record.date);
        const day = date.getDate();
        const month = date.toLocaleDateString('en-US', { month: 'short' });
        const year = date.getFullYear();
        return `
        <tr data-id="${record.id}">
          <td>
            <div style="text-align: center;">
              <div style="font-size: 20px; font-weight: 700; line-height: 1;">${day}</div>
              <div style="font-size: 11px; color: #999; margin-top: 2px;">${month} ${year}</div>
            </div>
          </td>
          <td class="number-cell">${(record.gold_given || 0).toFixed(2)}</td>
          <td class="number-cell">${(record.gold_received || 0).toFixed(2)}</td>
          <td class="number-cell ${record.balance >= 0 ? 'positive' : 'negative'}">${(record.balance || 0).toFixed(2)}</td>
          <td class="number-cell">${currencySymbol} ${(record.labor_cost || 0).toFixed(2)}</td>
          <td class="number-cell">${currencySymbol} ${(record.payment_made || 0).toFixed(2)}</td>
          <td>${record.notes || '-'}</td>
          <td>
            <button class="action-btn delete-btn" data-id="${record.id}">Delete</button>
          </td>
        </tr>
      `;
      }).join('');
      
      document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', handleDelete);
      });
    }
    
    // Summary Update
    function updateSummary() {
      const currencySymbol = window.elementSdk?.config?.currency_label || defaultConfig.currency_label;
      const filteredRecords = getFilteredRecords();
      
      const totals = filteredRecords.reduce((acc, record) => ({
        given: acc.given + (record.gold_given || 0),
        received: acc.received + (record.gold_received || 0),
        balance: acc.balance + (record.balance || 0),
        labor: acc.labor + (record.labor_cost || 0),
        payments: acc.payments + (record.payment_made || 0)
      }), { given: 0, received: 0, balance: 0, labor: 0, payments: 0 });
      
      document.getElementById('total-given').textContent = `${totals.given.toFixed(2)}g`;
      document.getElementById('total-received').textContent = `${totals.received.toFixed(2)}g`;
      document.getElementById('total-balance').textContent = `${totals.balance.toFixed(2)}g`;
      document.getElementById('total-labor').textContent = `${currencySymbol} ${totals.labor.toFixed(2)}`;
      document.getElementById('total-payments').textContent = `${currencySymbol} ${totals.payments.toFixed(2)}`;
      
      // Settlement calculations
      const unpaidLabor = totals.labor - totals.payments;
      const goldBalance = totals.balance;
      
      // Update period display
      const periodSpan = document.getElementById('settlement-period');
      const dateRangeDiv = document.getElementById('date-range');
      
      if (selectedMonth === 'all') {
        periodSpan.textContent = '(All Time / ÂÖ®ÈÉ®Êó∂Èó¥)';
        if (filteredRecords.length > 0) {
          const dates = filteredRecords.map(r => new Date(r.date)).sort((a, b) => a - b);
          const firstDate = dates[0].toLocaleDateString();
          const lastDate = dates[dates.length - 1].toLocaleDateString();
          dateRangeDiv.textContent = `Period: ${firstDate} - ${lastDate}`;
        } else {
          dateRangeDiv.textContent = '';
        }
      } else {
        const [year, month] = selectedMonth.split('-');
        const date = new Date(year, month - 1);
        const monthName = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
        periodSpan.textContent = `(${monthName})`;
        
        if (filteredRecords.length > 0) {
          const dates = filteredRecords.map(r => new Date(r.date)).sort((a, b) => a - b);
          const firstDate = dates[0].toLocaleDateString();
          const lastDate = dates[dates.length - 1].toLocaleDateString();
          dateRangeDiv.textContent = `${filteredRecords.length} transactions: ${firstDate} - ${lastDate}`;
        } else {
          dateRangeDiv.textContent = '';
        }
      }
      
      // Gold balance display
      document.getElementById('settlement-balance').textContent = `${Math.abs(goldBalance).toFixed(2)}g`;
      const balanceDesc = document.getElementById('balance-description');
      if (goldBalance > 0) {
        balanceDesc.textContent = 'Factory owes you / Â∑•ÂéÇÊ¨†‰Ω†';
        balanceDesc.style.color = 'rgba(255,255,255,0.9)';
      } else if (goldBalance < 0) {
        balanceDesc.textContent = 'You owe factory / ‰Ω†Ê¨†Â∑•ÂéÇ';
        balanceDesc.style.color = '#ffd700';
      } else {
        balanceDesc.textContent = 'Balanced / Â∑≤Âπ≥Ë°°';
        balanceDesc.style.color = 'rgba(255,255,255,0.9)';
      }
      
      // Payment status display
      document.getElementById('settlement-unpaid').textContent = `${currencySymbol} ${Math.abs(unpaidLabor).toFixed(2)}`;
      const paymentDesc = document.getElementById('payment-description');
      if (unpaidLabor > 0) {
        paymentDesc.textContent = 'You owe factory / ‰Ω†Ê¨†Â∑•ÂéÇ';
        paymentDesc.style.color = '#ffd700';
      } else if (unpaidLabor < 0) {
        paymentDesc.textContent = 'Factory owes you / Â∑•ÂéÇÊ¨†‰Ω†';
        paymentDesc.style.color = 'rgba(255,255,255,0.9)';
      } else {
        paymentDesc.textContent = 'All paid / Â∑≤‰ªòÊ∏Ö';
        paymentDesc.style.color = 'rgba(255,255,255,0.9)';
      }
      
      // Overall status
      const settlementStatus = document.getElementById('settlement-status');
      if (unpaidLabor === 0 && goldBalance === 0) {
        settlementStatus.textContent = '‚úì Fully Settled / ÂÆåÔøΩÔøΩÔøΩÔøΩÁªìÊ∏Ö';
        settlementStatus.style.color = 'white';
      } else if (unpaidLabor > 0 || goldBalance < 0) {
        settlementStatus.textContent = '‚ö†ÔøΩÔøΩÔøΩ You Owe / ‰Ω†Ê¨†Ê¨æ';
        settlementStatus.style.color = '#ffd700';
      } else {
        settlementStatus.textContent = '‚úì Factory Owes You / Â∑•ÂéÇÊ¨†‰Ω†';
        settlementStatus.style.color = '#90EE90';
      }
    }
    
    // Delete Handler
    function handleDelete(e) {
      const btn = e.target;
      const recordId = btn.dataset.id;
      
      allRecords = allRecords.filter(r => r.id !== recordId);
      saveRecords();
      populateMonthFilter();
      updateRecordsTable();
      updateSummary();
      showToast('‚úÖ Record deleted successfully!');
    }
    
    // Balance Calculator
    function calculateBalance() {
      const given = parseFloat(document.getElementById('gold-given').value) || 0;
      const received = parseFloat(document.getElementById('gold-received').value) || 0;
      const balance = given - received;
      document.getElementById('balance').value = balance.toFixed(2);
    }
    
    // Form Submit
    document.getElementById('record-form').addEventListener('submit', (e) => {
      e.preventDefault();
      
      const dateValue = document.getElementById('date').value;
      if (!dateValue) {
        showToast('‚ö†Ô∏è Please select a date!');
        return;
      }
      
      const formData = {
        id: Date.now().toString(),
        date: dateValue,
        gold_given: parseFloat(document.getElementById('gold-given').value) || 0,
        gold_received: parseFloat(document.getElementById('gold-received').value) || 0,
        balance: parseFloat(document.getElementById('balance').value) || 0,
        labor_cost: parseFloat(document.getElementById('labor-cost').value) || 0,
        payment_made: parseFloat(document.getElementById('payment-made').value) || 0,
        notes: document.getElementById('notes').value.trim() || ''
      };
      
      allRecords.push(formData);
      allRecords.sort((a, b) => new Date(a.date) - new Date(b.date));
      saveRecords();
      
      document.getElementById('record-form').reset();
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date').value = today;
      document.getElementById('balance').value = '';
      
      populateMonthFilter();
      updateRecordsTable();
      updateSummary();
      showToast('‚úÖ Record added successfully!');
    });
    
    // Export PDF Function
    function exportPDF(records, isFiltered = false) {
      if (records.length === 0) {
        showToast('‚ö†Ô∏è No records to export!');
        return;
      }
      
      if (typeof window.jspdf === 'undefined') {
        showToast('‚ö†Ô∏è PDF library not loaded. Please refresh the page.');
        return;
      }
      
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      
      const title = window.elementSdk?.config?.app_title || defaultConfig.app_title;
      const currencySymbol = window.elementSdk?.config?.currency_label || defaultConfig.currency_label;
      
      doc.setFontSize(18);
      doc.text(title, 14, 20);
      
      // Add filter info if filtered
      if (isFiltered && selectedMonth !== 'all') {
        const [year, month] = selectedMonth.split('-');
        const date = new Date(year, month - 1);
        const monthName = date.toLocaleDateString('en-US', { year: 'numeric', month: 'long' });
        doc.setFontSize(14);
        doc.text(`Monthly Report: ${monthName}`, 14, 28);
        doc.setFontSize(11);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 35);
      } else {
        doc.setFontSize(11);
        doc.text(`Generated: ${new Date().toLocaleString()}`, 14, 28);
      }
      
      const startY = isFiltered && selectedMonth !== 'all' ? 42 : 35;
      
      const tableData = records.map(record => [
        new Date(record.date).toLocaleDateString(),
        (record.gold_given || 0).toFixed(2),
        (record.gold_received || 0).toFixed(2),
        (record.balance || 0).toFixed(2),
        `${currencySymbol} ${(record.labor_cost || 0).toFixed(2)}`,
        `${currencySymbol} ${(record.payment_made || 0).toFixed(2)}`,
        record.notes || '-'
      ]);
      
      doc.autoTable({
        startY: startY,
        head: [['Date', 'Given (g)', 'Received (g)', 'Balance (g)', 'Labor Cost', 'Payment', 'Notes']],
        body: tableData,
        theme: 'striped',
        headStyles: { fillColor: [102, 126, 234] },
        styles: {
          font: 'helvetica',
          fontStyle: 'normal'
        },
        didParseCell: function(data) {
          // Enable word wrap for notes column to handle Chinese characters
          if (data.column.index === 6) {
            data.cell.styles.cellWidth = 'wrap';
          }
        }
      });
      
      const finalY = doc.lastAutoTable.finalY + 10;
      
      const totals = records.reduce((acc, record) => ({
        given: acc.given + (record.gold_given || 0),
        received: acc.received + (record.gold_received || 0),
        balance: acc.balance + (record.balance || 0),
        labor: acc.labor + (record.labor_cost || 0),
        payments: acc.payments + (record.payment_made || 0)
      }), { given: 0, received: 0, balance: 0, labor: 0, payments: 0 });
      
      doc.setFontSize(12);
      doc.setFont(undefined, 'bold');
      doc.text('Summary:', 14, finalY);
      doc.setFont(undefined, 'normal');
      doc.text(`Total Gold Given: ${totals.given.toFixed(2)}g`, 14, finalY + 7);
      doc.text(`Total Gold Received: ${totals.received.toFixed(2)}g`, 14, finalY + 14);
      doc.text(`Total Balance: ${totals.balance.toFixed(2)}g`, 14, finalY + 21);
      doc.text(`Total Labor Cost: ${currencySymbol} ${totals.labor.toFixed(2)}`, 14, finalY + 28);
      doc.text(`Total Payments: ${currencySymbol} ${totals.payments.toFixed(2)}`, 14, finalY + 35);
      
      const unpaidLabor = totals.labor - totals.payments;
      doc.setFont(undefined, 'bold');
      doc.text('Final Settlement:', 14, finalY + 49);
      doc.setFont(undefined, 'normal');
      doc.text(`Outstanding Balance: ${totals.balance.toFixed(2)}g`, 14, finalY + 56);
      doc.text(`Unpaid Labor: ${currencySymbol} ${unpaidLabor.toFixed(2)}`, 14, finalY + 63);
      
      if (unpaidLabor > 0) {
        doc.setTextColor(255, 0, 0);
        doc.text(`Status: Outstanding Payment Required`, 14, finalY + 70);
      } else if (unpaidLabor < 0) {
        doc.setTextColor(0, 128, 0);
        doc.text(`Status: Overpaid by ${currencySymbol} ${Math.abs(unpaidLabor).toFixed(2)}`, 14, finalY + 70);
      } else {
        doc.setTextColor(0, 128, 0);
        doc.text('Status: All Settled', 14, finalY + 70);
      }
      doc.setTextColor(0, 0, 0);
      
      let filename = `gold-business-${new Date().toISOString().split('T')[0]}`;
      if (isFiltered && selectedMonth !== 'all') {
        filename = `gold-business-${selectedMonth}`;
      }
      
      doc.save(`${filename}.pdf`);
      showToast('‚úÖ PDF exported successfully!');
    }
    
    // Export All Records
    document.getElementById('export-btn').addEventListener('click', () => {
      exportPDF(allRecords, false);
    });
    
    // Export Filtered Records
    document.getElementById('export-filtered-btn').addEventListener('click', () => {
      const filteredRecords = getFilteredRecords();
      exportPDF(filteredRecords, true);
    });
    
    // Export Excel Function
    function exportExcel(records, isFiltered = false) {
      if (records.length === 0) {
        showToast('‚ö†Ô∏è No records to export!');
        return;
      }
      
      if (typeof XLSX === 'undefined') {
        showToast('‚ö†Ô∏è Excel library not loaded. Please refresh the page.');
        return;
      }
      
      const currencySymbol = window.elementSdk?.config?.currency_label || defaultConfig.currency_label;
      const title = window.elementSdk?.config?.app_title || defaultConfig.app_title;
      
      // Prepare data for Excel
      const excelData = records.map(record => ({
        'Date': new Date(record.date).toLocaleDateString(),
        'Gold Given (g)': (record.gold_given || 0).toFixed(2),
        'Gold Received (g)': (record.gold_received || 0).toFixed(2),
        'Balance (g)': (record.balance || 0).toFixed(2),
        [`Labor Cost (${currencySymbol})`]: (record.labor_cost || 0).toFixed(2),
        [`Payment Made (${currencySymbol})`]: (record.payment_made || 0).toFixed(2),
        'Notes': record.notes || '-'
      }));
      
      // Calculate totals
      const totals = records.reduce((acc, record) => ({
        given: acc.given + (record.gold_given || 0),
        received: acc.received + (record.gold_received || 0),
        balance: acc.balance + (record.balance || 0),
        labor: acc.labor + (record.labor_cost || 0),
        payments: acc.payments + (record.payment_made || 0)
      }), { given: 0, received: 0, balance: 0, labor: 0, payments: 0 });
      
      const unpaidLabor = totals.labor - totals.payments;
      
      // Add empty row
      excelData.push({
        'Date': '',
        'Gold Given (g)': '',
        'Gold Received (g)': '',
        'Balance (g)': '',
        [`Labor Cost (${currencySymbol})`]: '',
        [`Payment Made (${currencySymbol})`]: '',
        'Notes': ''
      });
      
      // Add column totals row FIRST
      excelData.push({
        'Date': 'TOTAL',
        'Gold Given (g)': totals.given.toFixed(2),
        'Gold Received (g)': totals.received.toFixed(2),
        'Balance (g)': totals.balance.toFixed(2),
        [`Labor Cost (${currencySymbol})`]: totals.labor.toFixed(2),
        [`Payment Made (${currencySymbol})`]: totals.payments.toFixed(2),
        'Notes': ''
      });
      
      // Add empty row before summary
      excelData.push({
        'Date': '',
        'Gold Given (g)': '',
        'Gold Received (g)': '',
        'Balance (g)': '',
        [`Labor Cost (${currencySymbol})`]: '',
        [`Payment Made (${currencySymbol})`]: '',
        'Notes': ''
      });
      
      // Add summary section
      excelData.push({
        'Date': 'SUMMARY',
        'Gold Given (g)': '',
        'Gold Received (g)': '',
        'Balance (g)': '',
        [`Labor Cost (${currencySymbol})`]: '',
        [`Payment Made (${currencySymbol})`]: '',
        'Notes': ''
      });
      
      excelData.push({
        'Date': 'Total Gold Given',
        'Gold Given (g)': totals.given.toFixed(2) + 'g',
        'Gold Received (g)': '',
        'Balance (g)': '',
        [`Labor Cost (${currencySymbol})`]: '',
        [`Payment Made (${currencySymbol})`]: '',
        'Notes': ''
      });
      
      excelData.push({
        'Date': 'Total Gold Received',
        'Gold Given (g)': totals.received.toFixed(2) + 'g',
        'Gold Received (g)': '',
        'Balance (g)': '',
        [`Labor Cost (${currencySymbol})`]: '',
        [`Payment Made (${currencySymbol})`]: '',
        'Notes': ''
      });
      
      excelData.push({
        'Date': 'Total Balance',
        'Gold Given (g)': totals.balance.toFixed(2) + 'g',
        'Gold Received (g)': '',
        'Balance (g)': '',
        [`Labor Cost (${currencySymbol})`]: '',
        [`Payment Made (${currencySymbol})`]: '',
        'Notes': ''
      });
      
      excelData.push({
        'Date': 'Total Labor Cost',
        'Gold Given (g)': `${currencySymbol} ${totals.labor.toFixed(2)}`,
        'Gold Received (g)': '',
        'Balance (g)': '',
        [`Labor Cost (${currencySymbol})`]: '',
        [`Payment Made (${currencySymbol})`]: '',
        'Notes': ''
      });
      
      excelData.push({
        'Date': 'Total Payments',
        'Gold Given (g)': `${currencySymbol} ${totals.payments.toFixed(2)}`,
        'Gold Received (g)': '',
        'Balance (g)': '',
        [`Labor Cost (${currencySymbol})`]: '',
        [`Payment Made (${currencySymbol})`]: '',
        'Notes': ''
      });
      
      excelData.push({
        'Date': 'Unpaid Labor',
        'Gold Given (g)': `${currencySymbol} ${unpaidLabor.toFixed(2)}`,
        'Gold Received (g)': '',
        'Balance (g)': '',
        [`Labor Cost (${currencySymbol})`]: '',
        [`Payment Made (${currencySymbol})`]: '',
        'Notes': ''
      });
      
      // Create workbook and worksheet
      const wb = XLSX.utils.book_new();
      const ws = XLSX.utils.json_to_sheet(excelData);
      
      // Set column widths
      ws['!cols'] = [
        { wch: 12 },  // Date
        { wch: 15 },  // Gold Given
        { wch: 15 },  // Gold Received
        { wch: 12 },  // Balance
        { wch: 15 },  // Labor Cost
        { wch: 15 },  // Payment Made
        { wch: 30 }   // Notes (wider for Chinese characters)
      ];
      
      XLSX.utils.book_append_sheet(wb, ws, 'Gold Business');
      
      // Generate filename
      let filename = `gold-business-${new Date().toISOString().split('T')[0]}`;
      if (isFiltered && selectedMonth !== 'all') {
        filename = `gold-business-${selectedMonth}`;
      }
      
      // Save file
      XLSX.writeFile(wb, `${filename}.xlsx`);
      showToast('‚úÖ Excel file exported successfully!');
    }
    
    // Export All Records to Excel
    document.getElementById('export-excel-btn').addEventListener('click', () => {
      exportExcel(allRecords, false);
    });
    
    // Export Filtered Records to Excel
    document.getElementById('export-excel-filtered-btn').addEventListener('click', () => {
      const filteredRecords = getFilteredRecords();
      exportExcel(filteredRecords, true);
    });
    
    // Toast Notification
    function showToast(message) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.remove();
      }, 3000);
    }
    
    // Config Change Handler
    async function onConfigChange(config) {
      const title = config.app_title || defaultConfig.app_title;
      const currency = config.currency_label || defaultConfig.currency_label;
      const bgColor = config.background_color || defaultConfig.background_color;
      const surfaceColor = config.surface_color || defaultConfig.surface_color;
      const textColor = config.text_color || defaultConfig.text_color;
      const primaryColor = config.primary_action || defaultConfig.primary_action;
      const secondaryColor = config.secondary_action || defaultConfig.secondary_action;
      
      document.getElementById('app-title').textContent = title;
      document.getElementById('currency-symbol').textContent = currency;
      document.getElementById('currency-symbol2').textContent = currency;
      
      document.body.style.background = `linear-gradient(135deg, ${bgColor} 0%, ${primaryColor} 100%)`;
      
      document.querySelectorAll('.header, .input-card, .records-card').forEach(el => {
        el.style.background = surfaceColor;
      });
      
      document.querySelectorAll('h1, h2, label, td').forEach(el => {
        if (!el.classList.contains('summary-label') && !el.classList.contains('summary-value')) {
          el.style.color = textColor;
        }
      });
      
      document.querySelectorAll('.btn-primary').forEach(el => {
        el.style.background = primaryColor;
      });
      
      document.querySelectorAll('.btn-secondary').forEach(el => {
        el.style.background = secondaryColor;
      });
      
      document.querySelectorAll('th').forEach(el => {
        el.style.background = primaryColor;
      });
      
      updateSummary();
    }
    
    // Event Listeners
    document.getElementById('gold-given').addEventListener('input', calculateBalance);
    document.getElementById('gold-received').addEventListener('input', calculateBalance);
    
    document.getElementById('month-filter').addEventListener('change', (e) => {
      selectedMonth = e.target.value;
      updateRecordsTable();
      updateSummary();
    });
    
    // Initialize
    function init() {
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('date').value = today;
      
      loadRecords();
      populateMonthFilter();
      updateRecordsTable();
      updateSummary();
    }
    
    // Element SDK Initialization
    if (window.elementSdk) {
      window.elementSdk.init({
        defaultConfig,
        onConfigChange,
        mapToCapabilities: (config) => ({
          recolorables: [
            {
              get: () => config.background_color || defaultConfig.background_color,
              set: (value) => {
                config.background_color = value;
                window.elementSdk.setConfig({ background_color: value });
              }
            },
            {
              get: () => config.surface_color || defaultConfig.surface_color,
              set: (value) => {
                config.surface_color = value;
                window.elementSdk.setConfig({ surface_color: value });
              }
            },
            {
              get: () => config.text_color || defaultConfig.text_color,
              set: (value) => {
                config.text_color = value;
                window.elementSdk.setConfig({ text_color: value });
              }
            },
            {
              get: () => config.primary_action || defaultConfig.primary_action,
              set: (value) => {
                config.primary_action = value;
                window.elementSdk.setConfig({ primary_action: value });
              }
            },
            {
              get: () => config.secondary_action || defaultConfig.secondary_action,
              set: (value) => {
                config.secondary_action = value;
                window.elementSdk.setConfig({ secondary_action: value });
              }
            }
          ],
          borderables: [],
          fontEditable: undefined,
          fontSizeable: undefined
        }),
        mapToEditPanelValues: (config) => new Map([
          ["app_title", config.app_title || defaultConfig.app_title],
          ["currency_label", config.currency_label || defaultConfig.currency_label]
        ])
      });
    }
    
    // Start the app
    init();
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9a25cf0ab5925615',t:'MTc2Mzc4NzA1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>